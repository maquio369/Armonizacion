{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>{% block title %}Armonización Contable - Gobierno de Chiapas{% endblock %}</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link href="{% static 'css/chiapas-style.css' %}" rel="stylesheet">
    
    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Header Principal -->
    <header class="header-principal">
        <div class="container-fluid">
            <div class="row align-items-center py-2">
                <div class="col-md-3">
                    <div class="logo-section d-flex align-items-center">
                        <!-- Botón Toggle en el header -->
                        <button class="sidebar-toggle-btn me-3 d-none d-md-block" type="button" onclick="handleSidebar()">
                            <i class="fas fa-bars"></i>
                        </button>
                        <button class="btn-menu d-md-none me-3" type="button" onclick="handleSidebar()">
                            <i class="fas fa-bars text-white"></i>
                        </button>
                        <div class="logo-gov">
                            <img src="{% static 'images/jamach-negro.png' %}" alt="Logo" class="navbar-logo me-2">
                            <span class="logo-text text-white fw-bold" style="white-space: nowrap; font-size: 0.85rem;">ARMONIZACIÓN CONTABLE</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-9">
                    <nav class="nav-principal d-none d-md-flex justify-content-end">
                        <a href="https://chiapas.gob.mx/participa/" class="nav-link text-white" target="_blank">Participa</a>
                        <a href="https://chiapas.gob.mx/servicios-por-entidad/" class="nav-link text-white" target="_blank">Trámites</a>
                        <a href="https://chiapas.gob.mx/gobierno/" class="nav-link text-white" target="_blank">Gobierno</a>
                        <a href="https://consultapublicamx.plataformadetransparencia.org.mx/vut-web/faces/view/consultaPublica.xhtml#obligaciones" class="nav-link text-white" target="_blank">Transparencia</a>
                        <a href="https://chiapas.gob.mx/" class="nav-link text-white" target="_blank">chiapas.gob.mx</a>
                    </nav>
                </div>
            </div>
        </div>
    </header>

    <!-- Header Secundario -->
    <div class="header-secundario">
        <div class="container-fluid">
            <div class="row">
                <div class="col">
                    <div class="transparencia-header">
                        <div class="d-flex justify-content-center align-items-center py-3">
                            <div class="oficina-label">OFICINA DEL GOBERNADOR</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Contenido Principal -->
    <div class="main-content">
        <div class="container-fluid p-0">
            <div class="row g-0">
                <!-- Sidebar Colapsable -->
                <div class="sidebar-container" id="sidebarContainer">
                    <!-- Iconos que siempre quedan visibles -->
                    <div class="sidebar-icons-bar">
                        <!-- Icono Ley 1 -->
                        <div class="icon-item" data-target="ley1" data-ley-id="1">
                            <i class="fas fa-balance-scale"></i>
                            <!-- Panel flotante para Ley General de Contabilidad -->
                            <div class="hover-panel" id="hoverPanel1">
                                <div class="hover-panel-header">
                                    <i class="fas fa-balance-scale me-2"></i>
                                    <span>Ley General de Contabilidad Gubernamental</span>
                                </div>
                                <div class="hover-panel-items">
                                    <!-- Los sub-artículos se cargarán dinámicamente -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Icono Ley 2 -->
                        <div class="icon-item" data-target="ley2" data-ley-id="2">
                            <i class="fas fa-chart-line"></i>
                            <!-- Panel flotante para Ley de Disciplina Financiera -->
                            <div class="hover-panel" id="hoverPanel2">
                                <div class="hover-panel-header">
                                    <i class="fas fa-chart-line me-2"></i>
                                    <span>Ley de Disciplina Financiera</span>
                                </div>
                                <div class="hover-panel-items">
                                    <!-- Los sub-artículos se cargarán dinámicamente -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sidebar completo -->
                    <div class="sidebar">
                        <!-- Logo dentro del sidebar -->
                        <div class="sidebar-logo-section">
                            {% block logo_personalizado %}
                            <div class="text-center">
                                <img src="{% static 'images/logo-humanismo(72x108).png' %}" 
                                     alt="Logo Gobierno de Chiapas" 
                                     class="logo-custom">
                            </div>
                            {% endblock %}
                        </div>

                        <!-- Navegación de Leyes -->
                        <nav class="leyes-nav">
                            {% block sidebar %}
                            <!-- Contenido del sidebar se define en cada template -->
                            {% endblock %}
                        </nav>
                    </div>
                </div>

                <!-- Área de Contenido -->
                <div class="content-column">
                    <div class="content-area">
                        {% if messages %}
                            {% for message in messages %}
                                <div class="alert alert-{{ message.tags }} alert-dismissible fade show m-3" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            {% endfor %}
                        {% endif %}

                        {% block content %}{% endblock %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pie de página -->
    <footer class="bg-dark text-white text-center py-2">
        <div class="container-fluid">
            <small>GOBIERNO DE CHIAPAS 2024 - 2030</small>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Sidebar Toggle Script -->
<script>
    function handleSidebar() {
        const sidebar = document.getElementById('sidebarContainer');
        const isMobile = window.innerWidth < 768;

        if (isMobile) {
            sidebar.classList.toggle('show');
            if (sidebar.classList.contains('show')) {
                addMobileOverlay();
            } else {
                removeMobileOverlay();
            }
        } else {
            sidebar.classList.toggle('collapsed');
            updateToggleIcon();
        }
    }

    function addMobileOverlay() {
        let overlay = document.getElementById('mobile-overlay');
        if (!overlay) {
            overlay = document.createElement('div');
            overlay.id = 'mobile-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 1040; /* Ensure it's on top of content but below sidebar */
            `;
            overlay.onclick = handleSidebar; // Click overlay to close
            document.body.appendChild(overlay);
        }
    }

    function removeMobileOverlay() {
        const overlay = document.getElementById('mobile-overlay');
        if (overlay) {
            overlay.remove();
        }
    }

    function checkScreenSize() {
        const sidebar = document.getElementById('sidebarContainer');
        const isMobile = window.innerWidth < 768;

        if (isMobile) {
            sidebar.classList.add('collapsed');
            // Ensure the 'show' class is removed on resize if sidebar was open
            if (sidebar.classList.contains('show')) {
                sidebar.classList.remove('show');
                removeMobileOverlay();
            }
        } else {
            // On desktop, ensure mobile-specific classes are removed
            sidebar.classList.remove('show');
            removeMobileOverlay();
        }
        updateToggleIcon();
    }

    function updateToggleIcon() {
        const sidebar = document.getElementById('sidebarContainer');
        const toggleBtn = document.querySelector('.sidebar-toggle-btn');
        if (!toggleBtn) return; // Button might not exist in all views
        const icon = toggleBtn.querySelector('i');
        
        if (sidebar.classList.contains('collapsed')) {
            icon.className = 'fas fa-chevron-right';
        } else {
            icon.className = 'fas fa-bars';
        }
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', function() {
        checkScreenSize();
        updateToggleIcon(); // Set initial icon state
    });

    window.addEventListener('resize', checkScreenSize);

        
        // Función para cargar sub-artículos dinámicamente

        function loadSubArticulos() {
    // Datos completos de las leyes con URLs de Django
    const leyData = {
        1: {
            nombre: "Ley General de Contabilidad Gubernamental",
            subarticulos: [
                { 
                    icon: "fas fa-file-invoice-dollar", 
                    nombre: "Presupuesto de Egresos",
                    id: 1 // Este ID debe coincidir con el ID real de la base de datos
                },
                { 
                    icon: "fas fa-chart-bar", 
                    nombre: "Información Contable",
                    id: 2
                },
                { 
                    icon: "fas fa-file-alt", 
                    nombre: "Información Presupuestaria",
                    id: 3
                },
                { 
                    icon: "fas fa-project-diagram", 
                    nombre: "Información Programática",
                    id: 4
                },
                { 
                    icon: "fas fa-hand-holding-usd", 
                    nombre: "Ayudas y Subsidios",
                    id: 5
                },
                { 
                    icon: "fas fa-file-contract", 
                    nombre: "Cuenta Pública",
                    id: 6
                },
                { 
                    icon: "fas fa-clipboard-check", 
                    nombre: "Información Cualitativa",
                    id: 7
                },
                { 
                    icon: "fas fa-boxes", 
                    nombre: "Inventario Físico de Bienes",
                    id: 8
                }
            ]
        },
        2: {
            nombre: "Ley de Disciplina Financiera",
            subarticulos: [
                { 
                    icon: "fas fa-chart-line", 
                    nombre: "Información de la Ley de Disciplina Financiera",
                    id: 9
                },
                { 
                    icon: "fas fa-paperclip", 
                    nombre: "Anexos de la Ley de Disciplina Financiera",
                    id: 10
                }
            ]
        }
    };

    // Cargar los sub-artículos en los paneles
    Object.keys(leyData).forEach(leyId => {
        const panel = document.getElementById(`hoverPanel${leyId}`);
        if (!panel) return;
        
        const itemsContainer = panel.querySelector('.hover-panel-items');
        
        leyData[leyId].subarticulos.forEach(subarticulo => {
            const item = document.createElement('a');
            item.className = 'hover-panel-item';
            
            // Generar URL dinámicamente basada en el ID del sub-artículo
            // Asumiendo que tienes una vista para sub-artículos
            item.href = `/subarticulo/${subarticulo.id}/`;
            
            item.innerHTML = `
                <i class="${subarticulo.icon}"></i>
                ${subarticulo.nombre}
            `;
            
            // Agregar event listener para navegación
            item.addEventListener('click', function(e) {
                e.preventDefault();
                window.location.href = this.href;
            });
            
            itemsContainer.appendChild(item);
        });
    });
}

// Función para manejar clicks en los iconos principales
function handleIconClick(iconElement) {
    const sidebar = document.getElementById('sidebarContainer');
    
    // Si el sidebar está colapsado, expandirlo
    if (sidebar.classList.contains('collapsed')) {
        sidebar.classList.remove('collapsed');
        updateToggleIcon();
        
        // Opcional: Expandir automáticamente la ley correspondiente
        const leyId = iconElement.getAttribute('data-ley-id');
        const collapseElement = document.getElementById(`ley${leyId}`);
        if (collapseElement && !collapseElement.classList.contains('show')) {
            const bootstrap = window.bootstrap || {};
            if (bootstrap.Collapse) {
                new bootstrap.Collapse(collapseElement, { show: true });
            } else {
                collapseElement.classList.add('show');
            }
        }
    }
}

// Función para obtener URLs dinámicamente desde Django (alternativa)
function getSubarticuloUrl(subarticulo) {
    // Opción 1: URLs hardcodeadas (más simple)
    return `/subarticulo/${subarticulo.id}/`;
    
    // Opción 2: Si necesitas URLs más dinámicas, puedes usar:
    // return window.DJANGO_URLS ? window.DJANGO_URLS.subarticulo_detail.replace('0', subarticulo.id) : '#';
}

// Función para cargar datos desde el servidor (alternativa avanzada)
async function loadSubarticulosFromServer() {
    try {
        const response = await fetch('/api/leyes-subarticulos/');
        const data = await response.json();
        
        // Procesar datos del servidor
        Object.keys(data).forEach(leyId => {
            const panel = document.getElementById(`hoverPanel${leyId}`);
            if (!panel) return;
            
            const itemsContainer = panel.querySelector('.hover-panel-items');
            itemsContainer.innerHTML = ''; // Limpiar contenido existente
            
            data[leyId].subarticulos.forEach(subarticulo => {
                const item = document.createElement('a');
                item.className = 'hover-panel-item';
                item.href = subarticulo.url; // URL viene del servidor
                item.innerHTML = `
                    <i class="${subarticulo.icon}"></i>
                    ${subarticulo.nombre}
                `;
                itemsContainer.appendChild(item);
            });
        });
    } catch (error) {
        console.error('Error cargando sub-artículos:', error);
        // Fallback a datos locales
        loadSubArticulos();
    }
}

// Función para sincronizar con el estado actual de la página
function syncNavigationState() {
    // Obtener la URL actual para determinar qué elementos deben estar activos
    const currentPath = window.location.pathname;
    
    // Marcar elementos activos en la navegación
    document.querySelectorAll('.hover-panel-item').forEach(item => {
        if (item.href === window.location.href) {
            item.classList.add('active');
        } else {
            item.classList.remove('active');
        }
    });
}

// Actualizar icono del botón toggle
function updateToggleIcon() {
    const sidebar = document.getElementById('sidebarContainer');
    const toggleBtn = document.querySelector('.sidebar-toggle-btn');
    const icon = toggleBtn.querySelector('i');
    
    if (sidebar.classList.contains('collapsed')) {
        icon.className = 'fas fa-chevron-right';
    } else {
        icon.className = 'fas fa-bars';
    }
}

// Función principal de toggle
function toggleSidebar() {
    const sidebar = document.getElementById('sidebarContainer');
    sidebar.classList.toggle('collapsed');
    updateToggleIcon();
}

// Auto-colapsar en pantallas pequeñas
function checkScreenSize() {
    const sidebar = document.getElementById('sidebarContainer');
    if (window.innerWidth < 768) {
        sidebar.classList.add('collapsed');
        updateToggleIcon();
    }
}

// Variable para evitar múltiples inicializaciones
let isInitialized = false;

// Inicialización cuando el DOM está listo
document.addEventListener('DOMContentLoaded', function() {
    if (isInitialized) return;
    isInitialized = true;
    
    // Cargar los sub-artículos
    loadSubArticulos();
    
    // Configurar event listeners para los iconos
    const iconItems = document.querySelectorAll('.icon-item');
    iconItems.forEach(icon => {
        icon.addEventListener('click', function() {
            handleIconClick(this);
        });
    });
    
    // Sincronizar estado de navegación
    syncNavigationState();
    
    // Configurar responsive
    checkScreenSize();
});

// Event listeners para cambios de pantalla
window.addEventListener('load', checkScreenSize);
window.addEventListener('resize', checkScreenSize);

// ==========================================
// NAVEGACIÓN DINÁMICA SIN RECARGAR PÁGINA
// ==========================================

// Función para cargar contenido dinámicamente
async function loadContent(url, updateHistory = true) {
    try {
        // Mostrar loading
        showLoadingSpinner();
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.success) {
            // Actualizar contenido principal
            const contentArea = document.querySelector('.content-area');
            contentArea.innerHTML = data.content;
            
            // Actualizar título de la página
            document.title = data.title + ' - Gobierno de Chiapas';
            
            // Actualizar URL sin recargar
            if (updateHistory) {
                history.pushState({ url: url }, data.title, url.replace('/api', '').replace('/content', ''));
            }
            
            // Re-inicializar event listeners
            initializeContentEventListeners();
            
            // Actualizar navegación activa en sidebar
            updateActiveNavigation(data.breadcrumb);
            
        } else {
            showError('Error al cargar el contenido: ' + data.error);
        }
        
    } catch (error) {
        console.error('Error:', error);
        showError('Error de conexión. Por favor, intenta de nuevo.');
    } finally {
        hideLoadingSpinner();
    }
}

// Función para mostrar spinner de carga
function showLoadingSpinner() {
    const contentArea = document.querySelector('.content-area');
    contentArea.innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-3 text-muted">Cargando contenido...</p>
        </div>
    `;
}

// Función para ocultar spinner
function hideLoadingSpinner() {
    // El contenido se reemplaza automáticamente
}

// Función para mostrar errores
function showError(message) {
    const contentArea = document.querySelector('.content-area');
    contentArea.innerHTML = `
        <div class="alert alert-danger m-3">
            <i class="fas fa-exclamation-triangle me-2"></i>
            ${message}
        </div>
    `;
}

// Función para actualizar navegación activa
function updateActiveNavigation(breadcrumb) {
    // Remover clases activas
    document.querySelectorAll('.ley-link, .subnav-item').forEach(item => {
        item.classList.remove('active');
    });
    
    // Encontrar y marcar elementos activos
    if (breadcrumb.ley) {
        const leyButtons = document.querySelectorAll('.ley-link');
        leyButtons.forEach(button => {
            const leyText = button.querySelector('.ley-text').textContent.trim();
            if (leyText === breadcrumb.ley) {
                button.classList.add('active');
                
                // Expandir si no está expandido
                const target = button.getAttribute('data-bs-target');
                const collapseElement = document.querySelector(target);
                if (collapseElement && !collapseElement.classList.contains('show')) {
                    collapseElement.classList.add('show');
                    button.setAttribute('aria-expanded', 'true');
                }
            }
        });
    }
    
    if (breadcrumb.subarticulo) {
        const subnavItems = document.querySelectorAll('.subnav-item');
        subnavItems.forEach(item => {
            if (item.textContent.trim() === breadcrumb.subarticulo) {
                item.classList.add('active');
            }
        });
    }
}

// Variable para rastrear si los listeners ya fueron agregados
let contentListenersAdded = false;

// Función para inicializar event listeners del contenido
function initializeContentEventListeners() {
    if (contentListenersAdded) return;
    contentListenersAdded = true;
    
    // Event listeners para botones de sub-artículos
    document.querySelectorAll('.load-subarticulo').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const subarticuloId = this.getAttribute('data-subarticulo-id');
            loadContent(`/api/subarticulo/${subarticuloId}/content/`);
        });
    });
    
    // Event listeners para filtros de año
    document.querySelectorAll('.filter-year').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const subarticuloId = this.getAttribute('data-subarticulo-id');
            const año = this.getAttribute('data-año');
            const url = `/api/subarticulo/${subarticuloId}/content/` + (año ? `?año=${año}` : '');
            loadContent(url);
        });
    });
    
    // Event listeners para navegación en sidebar
    document.querySelectorAll('.subnav-item').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const href = this.getAttribute('href');
            const subarticuloId = href.split('/').filter(part => part).pop();
            loadContent(`/api/subarticulo/${subarticuloId}/content/`);
        });
    });
}

// Manejar botón atrás/adelante del navegador
window.addEventListener('popstate', function(event) {
    if (event.state && event.state.url) {
        loadContent(event.state.url, false);
    } else {
        // Recargar página si no hay estado
        window.location.reload();
    }
});

// Actualizar la función de click en hover panels
function updateHoverPanelLinks() {
    document.querySelectorAll('.hover-panel-item').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const href = this.getAttribute('href');
            const subarticuloId = href.split('/').filter(part => part).pop();
            
            // Si el sidebar está colapsado, expandirlo primero
            const sidebar = document.getElementById('sidebarContainer');
            if (sidebar.classList.contains('collapsed')) {
                sidebar.classList.remove('collapsed');
                updateToggleIcon();
            }
            
            // Cargar contenido
            loadContent(`/api/subarticulo/${subarticuloId}/content/`);
        });
    });
}

// Actualizar la función de inicialización
document.addEventListener('DOMContentLoaded', function() {
    if (isInitialized) return;
    
    // Inicializar navegación dinámica
    initializeContentEventListeners();
    updateHoverPanelLinks();
});

    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>
