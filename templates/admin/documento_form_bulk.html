{% extends 'admin/base_admin.html' %}

{% block extra_css %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />

<style>
    .form-card-rounded, .info-card-oval {
        font-family: 'Poppins', sans-serif;
    }
    .info-card-oval {
        border-radius: 1.5rem;
        border: none;
        background-color: #f8f9fa;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .info-card-oval .card-title {
        color: #006554;
        font-weight: bold;
    }
    .form-card-rounded {
        border-radius: 1.5rem;
        overflow: hidden;
    }
    .btn-custom-save {
        background-color: #006554;
        border-color: #006554;
        color: white;
    }
    .btn-custom-save:hover {
        background-color: #004a3d;
        border-color: #004a3d;
        color: white;
    }
    .btn-cancel-custom {
        background-color: #6c757d;
        border-color: #6c757d;
        color: white;
    }
    .btn-cancel-custom:hover {
        background-color: #5a6268;
        border-color: #545b62;
        color: white;
    }
    
    .select2-container--bootstrap-5 .select2-selection {
        min-height: calc(3.5rem + 2px);
        padding: 1.5rem 0.75rem 0.25rem;
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
    }
    
    .select2-container--bootstrap-5 .select2-selection--single .select2-selection__rendered {
        padding: 0.5rem 0 0 0;
        line-height: 1.5;
        margin-top: 0.25rem;
    }
    
    .select2-container--bootstrap-5 .select2-selection--single .select2-selection__arrow {
        height: calc(3.5rem + 2px);
        right: 0.75rem;
    }
    
    .form-floating > .select2-container {
        height: calc(3.5rem + 2px);
    }
    
    .form-floating > .select2-container .select2-selection {
        height: 100%;
        border: 1px solid #ced4da;
    }
    
    .form-floating > label {
        z-index: 4;
    }

    .trimestre-section {
        border: 2px dashed #dee2e6;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }

    .trimestre-section.has-file {
        border-color: #198754;
        background-color: #f8fff9;
    }

    .trimestre-section h6 {
        color: #006554;
        margin-bottom: 0.75rem;
    }

    #trimestres-container {
        display: none;
    }
</style>
{% endblock %}

{% block title %}
    Subida Masiva de Documentos - Panel Administrativo
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow-lg border-0 mt-4 mb-4 form-card-rounded">
            <div class="card-header text-white text-center py-3" style="background-color: #006554;">
                <h4 class="mb-0">
                    <i class="fas fa-upload"></i> 
                    Subida Masiva de Documentos
                </h4>
                <small>Sube los 4 trimestres de una vez</small>
            </div>
            <div class="card-body p-4">
                <form method="post" enctype="multipart/form-data" id="documentoBulkForm" novalidate>
                    {% csrf_token %}

                    <div class="row g-3">
                        <div class="col-12">
                            <div class="form-floating">
                                {{ form.tipo_documento }}
                                <label for="id_tipo_documento">Tipo de Documento *</label>
                            </div>
                            {% if form.tipo_documento.errors %}
                                <div class="invalid-feedback d-block">{{ form.tipo_documento.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <div class="col-md-6">
                            <div class="form-floating">
                                {{ form.año }}
                                <label for="id_año">Año *</label>
                            </div>
                            {% if form.año.errors %}
                                <div class="invalid-feedback d-block">{{ form.año.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <!-- Contenedor para los 4 trimestres -->
                        <div class="col-12" id="trimestres-container">
                            <h5 class="mb-3 text-center" style="color: #006554;">
                                <i class="fas fa-calendar-alt me-2"></i>Archivos por Trimestre
                            </h5>
                            
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="trimestre-section" id="t1-section">
                                        <h6><i class="fas fa-file-pdf me-2"></i>Primer Trimestre (T1)</h6>
                                        <input type="file" class="form-control" name="archivo_t1" id="archivo_t1" accept=".pdf">
                                        <div class="form-text">Archivo PDF para T1</div>
                                        <div class="file-info mt-2" id="info_t1"></div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="trimestre-section" id="t2-section">
                                        <h6><i class="fas fa-file-pdf me-2"></i>Segundo Trimestre (T2)</h6>
                                        <input type="file" class="form-control" name="archivo_t2" id="archivo_t2" accept=".pdf">
                                        <div class="form-text">Archivo PDF para T2</div>
                                        <div class="file-info mt-2" id="info_t2"></div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="trimestre-section" id="t3-section">
                                        <h6><i class="fas fa-file-pdf me-2"></i>Tercer Trimestre (T3)</h6>
                                        <input type="file" class="form-control" name="archivo_t3" id="archivo_t3" accept=".pdf">
                                        <div class="form-text">Archivo PDF para T3</div>
                                        <div class="file-info mt-2" id="info_t3"></div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="trimestre-section" id="t4-section">
                                        <h6><i class="fas fa-file-pdf me-2"></i>Cuarto Trimestre (T4)</h6>
                                        <input type="file" class="form-control" name="archivo_t4" id="archivo_t4" accept=".pdf">
                                        <div class="form-text">Archivo PDF para T4</div>
                                        <div class="file-info mt-2" id="info_t4"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="alert alert-info mt-3">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Nota:</strong> Puedes subir solo los trimestres que tengas disponibles. Los campos vacíos serán ignorados.
                            </div>
                        </div>

                        <!-- Mensaje para documentos anuales -->
                        <div class="col-12" id="anual-message" style="display: none;">
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Este tipo de documento es <strong>anual</strong>. Usa el formulario normal para subir documentos anuales.
                                <a href="{% url 'administracion:documento_create' %}" class="btn btn-sm btn-outline-primary ms-2">
                                    <i class="fas fa-arrow-right me-1"></i>Ir al formulario normal
                                </a>
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4 pt-3 border-top">
                        <a href="{% url 'administracion:documento_list' %}" class="btn btn-cancel-custom btn-lg px-4 rounded-pill">
                            <i class="fas fa-times me-2"></i>Cancelar
                        </a>
                        <button type="submit" class="btn btn-custom-save btn-lg px-4 rounded-pill" id="btn-guardar">
                            <i class="fas fa-upload me-2"></i>Subir Documentos
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card mt-4 info-card-oval">
            <div class="card-body text-center p-4">
                <h6 class="card-title mb-4"><i class="fas fa-info-circle me-2"></i>Información del Sistema</h6>
                <div class="text-start">
                    <div class="mb-3">
                        <small class="text-muted d-block">Sistema</small>
                        <span class="fw-bold">Armonización Contable</span>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted d-block">Dependencia</small>
                        <span class="fw-bold">Gobierno de Chiapas</span>
                    </div>
                    <div>
                        <small class="text-muted d-block">Usuario</small>
                        <span class="fw-bold">{{ user.get_full_name|default:user.username }}</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-3 info-card-oval">
            <div class="card-body text-center p-4">
                <h6 class="card-title mb-4"><i class="fas fa-question-circle me-2"></i>Ayuda Rápida</h6>
                <ul class="list-unstyled text-start">
                    <li class="d-flex mb-2">
                        <i class="fas fa-circle-notch text-primary me-3 mt-1" style="font-size: 0.7rem;"></i>
                        <span class="small">Solo funciona con documentos <strong>trimestrales</strong>.</span>
                    </li>
                    <li class="d-flex mb-2">
                        <i class="fas fa-circle-notch text-success me-3 mt-1" style="font-size: 0.7rem;"></i>
                        <span class="small">Puedes subir solo algunos trimestres.</span>
                    </li>
                    <li class="d-flex mb-2">
                        <i class="fas fa-circle-notch text-warning me-3 mt-1" style="font-size: 0.7rem;"></i>
                        <span class="small">Solo archivos <strong>PDF</strong>, máximo 50MB.</span>
                    </li>
                    <li class="d-flex">
                        <i class="fas fa-circle-notch text-danger me-3 mt-1" style="font-size: 0.7rem;"></i>
                        <span class="small">Cambio <strong>temporal</strong> para carga masiva.</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tipoDocumentoSelect = document.getElementById('id_tipo_documento');
    const trimestresContainer = document.getElementById('trimestres-container');
    const anualMessage = document.getElementById('anual-message');
    const btnGuardar = document.getElementById('btn-guardar');
    
    function toggleTrimestres() {
        const selectedOption = tipoDocumentoSelect.options[tipoDocumentoSelect.selectedIndex];
        if (selectedOption.value) {
            fetch(`/admin-panel/api/tipo-documento/${selectedOption.value}/periodicidad/`)
                .then(response => response.json())
                .then(data => {
                    if (data.periodicidad === 'TRIMESTRAL') {
                        trimestresContainer.style.display = 'block';
                        anualMessage.style.display = 'none';
                        btnGuardar.disabled = false;
                    } else {
                        trimestresContainer.style.display = 'none';
                        anualMessage.style.display = 'block';
                        btnGuardar.disabled = true;
                    }
                })
                .catch(error => {
                    console.log('Error al obtener periodicidad:', error);
                });
        } else {
            trimestresContainer.style.display = 'none';
            anualMessage.style.display = 'none';
            btnGuardar.disabled = false;
        }
    }
    
    // Validación de archivos
    function validateFile(input, trimestre) {
        const file = input.files[0];
        const maxSize = 50 * 1024 * 1024; // 50MB
        const section = document.getElementById(`t${trimestre}-section`);
        const infoDiv = document.getElementById(`info_t${trimestre}`);
        
        if (file) {
            if (!file.name.toLowerCase().endsWith('.pdf')) {
                alert('Solo se permiten archivos PDF');
                input.value = '';
                return false;
            }
            
            if (file.size > maxSize) {
                alert('El archivo es demasiado grande. Máximo 50MB permitido.');
                input.value = '';
                return false;
            }
            
            section.classList.add('has-file');
            infoDiv.innerHTML = `
                <small class="text-success">
                    <i class="fas fa-check-circle me-1"></i>
                    ${file.name} (${formatFileSize(file.size)})
                </small>
            `;
        } else {
            section.classList.remove('has-file');
            infoDiv.innerHTML = '';
        }
        
        return true;
    }
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    // Event listeners
    tipoDocumentoSelect.addEventListener('change', toggleTrimestres);
    
    // Validación para cada archivo de trimestre
    ['1', '2', '3', '4'].forEach(t => {
        const input = document.getElementById(`archivo_t${t}`);
        if (input) {
            input.addEventListener('change', () => validateFile(input, t));
        }
    });
    
    // Inicializar Select2
    $('#id_tipo_documento').select2({
        theme: 'bootstrap-5',
        allowClear: true,
        width: '100%',
        language: {
            noResults: function() {
                return 'No se encontraron resultados';
            },
            searching: function() {
                return 'Buscando...';
            }
        }
    });
    
    $('#id_tipo_documento').on('select2:select', function() {
        toggleTrimestres();
    });
    
    // Validación del formulario
    document.getElementById('documentoBulkForm').addEventListener('submit', function(e) {
        const tipoDocumento = tipoDocumentoSelect.value;
        const año = document.querySelector('[name="año"]').value;
        
        if (!tipoDocumento || !año) {
            e.preventDefault();
            alert('Debe seleccionar tipo de documento y año');
            return false;
        }
        
        // Verificar que al menos un archivo esté seleccionado
        const archivos = ['archivo_t1', 'archivo_t2', 'archivo_t3', 'archivo_t4'];
        const tieneArchivos = archivos.some(name => {
            const input = document.querySelector(`[name="${name}"]`);
            return input && input.files.length > 0;
        });
        
        if (!tieneArchivos) {
            e.preventDefault();
            alert('Debe seleccionar al menos un archivo para subir');
            return false;
        }
        
        return true;
    });
    
    if (tipoDocumentoSelect.value) {
        toggleTrimestres();
    }
});
</script>
{% endblock %}